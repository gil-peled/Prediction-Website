<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk calculator</title>

    <!-- Risk calculator model code -->
    <script src="sigma_6mo.js" defer></script>
    <script src="sigma_12mo.js" defer></script>
    <script src="load_sigma.js" defer></script>
    <script src="prototype2_model.js" defer></script>
    <style>
        .comorbidities-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px 12px;
            font-size: 0.85em;
        }
        .labs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        @media (max-width: 768px) {
            .comorbidities-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .labs-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 480px) {
            .comorbidities-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Lab inputs: more transparent placeholder (grey values) */
        .labs-grid .lab-input::placeholder {
            opacity: 0.4;
            color: #999;
        }
        #resultsGrid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            #resultsGrid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <script src="loadNavbar.js"></script>
    <script src="content.js"></script>
    
    <div class="card" style="padding: 15px; margin-bottom: 10px;">
        <h2 style="margin: 0 0 8px 0; font-size: 1.5em;">Risk calculator (6-month & 12-month)</h2>
        <p style="margin: 0 0 8px 0; font-size: 0.9em;">Enter what you know. If a lab is missing, leave it blank (the model uses a missing-indicator).</p>
        <div id="error-message-container" style="display:none; color:red; font-size: 0.9em;"></div>
    </div>

    <div class="card" style="padding: 15px; margin-bottom: 10px;">
        <h3 style="margin: 0 0 8px 0; font-size: 1.1em;">Etiology</h3>
        <label for="etiology" style="display: block; margin-bottom: 4px; font-size: 0.9em;">Primary etiology:</label>
        <select id="etiology" name="etiology" style="width: 100%; padding: 6px; font-size: 0.9em;">
            <option value="MASLD">MASLD (baseline)</option>
            <option value="ALD">ALD</option>
            <option value="METALD">METALD</option>
            <option value="HCV">HCV</option>
            <option value="HBV">HBV</option>
            <option value="Biliary">Biliary</option>
            <option value="Other">Other</option>
            <option value="2+ Etiologies">2+ Etiologies</option>
            <option value="Unknown">Unknown</option>
        </select>
    </div>

    <div class="card" style="padding: 15px; margin-bottom: 10px;">
        <h3 style="margin: 0 0 8px 0; font-size: 1.1em;">Basic information</h3>
        <label for="ageInput" style="display: block; margin-bottom: 4px; font-size: 0.9em;">Age (years):</label>
        <input type="number" id="ageInput" name="ageInput" placeholder="18–90" min="0" step="1" style="width: 100%; padding: 6px; margin-bottom: 10px; font-size: 0.9em; box-sizing: border-box;">

        <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">Gender:</label>
            <div style="display: flex; gap: 15px;">
                <label style="display: flex; align-items: center; font-size: 0.9em; cursor: pointer;"><input type="radio" id="male" name="gender" value="male" style="margin-right: 4px;"> Male</label>
                <label style="display: flex; align-items: center; font-size: 0.9em; cursor: pointer;"><input type="radio" id="female" name="gender" value="female" checked style="margin-right: 4px;"> Female</label>
            </div>
        </div>

        <div style="display: flex; align-items: center; margin-top: 8px;">
            <input type="checkbox" id="hcc" name="hcc" style="margin-right: 6px;">
            <label for="hcc" style="font-size: 0.9em; cursor: pointer;">HCC</label>
        </div>
    </div>

    <div class="card" style="padding: 15px; margin-bottom: 10px;">
        <h3 style="margin: 0 0 8px 0; font-size: 1.1em;">Labs (optional)</h3>
        <div class="labs-grid">
            <div>
                <label for="labSodium" style="display: block; margin-bottom: 4px; font-size: 0.85em;">Sodium (mEq/L):</label>
                <input type="number" id="labSodium" class="lab-input" inputmode="decimal" placeholder="135" step="0.1" min="0" style="width: 100%; padding: 6px; font-size: 0.9em; box-sizing: border-box;">
            </div>
            <div>
                <label for="labCreatinine" style="display: block; margin-bottom: 4px; font-size: 0.85em;">Creatinine (mg/dL):</label>
                <input type="number" id="labCreatinine" class="lab-input" inputmode="decimal" placeholder="1.0" step="0.01" min="0" style="width: 100%; padding: 6px; font-size: 0.9em; box-sizing: border-box;">
            </div>
            <div>
                <label for="labPlatelet" style="display: block; margin-bottom: 4px; font-size: 0.85em;">Platelets (K/µL):</label>
                <input type="number" id="labPlatelet" class="lab-input" inputmode="decimal" placeholder="150" step="1" min="0" style="width: 100%; padding: 6px; font-size: 0.9em; box-sizing: border-box;">
            </div>
            <div>
                <label for="labAlbumin" style="display: block; margin-bottom: 4px; font-size: 0.85em;">Albumin (g/dL):</label>
                <input type="number" id="labAlbumin" class="lab-input" inputmode="decimal" placeholder="3.6" step="0.01" min="0" style="width: 100%; padding: 6px; font-size: 0.9em; box-sizing: border-box;">
            </div>
            <div>
                <label for="labINR" style="display: block; margin-bottom: 4px; font-size: 0.85em;">INR:</label>
                <input type="number" id="labINR" class="lab-input" inputmode="decimal" placeholder="1.2" step="0.01" min="0" style="width: 100%; padding: 6px; font-size: 0.9em; box-sizing: border-box;">
            </div>
            <div>
                <label for="labBilirubin" style="display: block; margin-bottom: 4px; font-size: 0.85em;">Bilirubin (mg/dL):</label>
                <input type="number" id="labBilirubin" class="lab-input" inputmode="decimal" placeholder="1.0" step="0.01" min="0" style="width: 100%; padding: 6px; font-size: 0.9em; box-sizing: border-box;">
            </div>
        </div>
    </div>

    <div class="card" style="padding: 15px; margin-bottom: 10px;">
        <h3 style="margin: 0 0 8px 0; font-size: 1.1em;">Comorbidities</h3>
        <div class="comorbidities-grid">
            <!-- Cardiovascular -->
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_prior_mi" data-predictor="Prior MI" style="margin-right: 5px; flex-shrink: 0;"> Myocardial infarction</label>
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_chf" data-predictor="CHF" style="margin-right: 5px; flex-shrink: 0;"> Congestive heart failure</label>
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_pad" data-predictor="PAD" style="margin-right: 5px; flex-shrink: 0;"> Peripheral vascular disease</label>
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_cva" data-predictor="CVA" style="margin-right: 5px; flex-shrink: 0;"> Cerebrovascular disease</label>
            <!-- Neurological -->
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_dementia" data-predictor="Dementia" style="margin-right: 5px; flex-shrink: 0;"> Dementia</label>
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_hemi" data-predictor="Hemiplegia" style="margin-right: 5px; flex-shrink: 0;"> Hemiplegia or paraplegia</label>
            <!-- Pulmonary -->
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_copd" data-predictor="COPD" style="margin-right: 5px; flex-shrink: 0;"> Chronic pulmonary disease</label>
            <!-- Gastrointestinal -->
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_pud" data-predictor="PUD" style="margin-right: 5px; flex-shrink: 0;"> Peptic ulcer disease</label>
            <!-- Rheumatologic -->
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_rheum" data-predictor="Rheumatic Disease" style="margin-right: 5px; flex-shrink: 0;"> Rheumatologic disease</label>
            <!-- Diabetes -->
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_dm_uncomp" data-predictor="Uncomplicated DA" style="margin-right: 5px; flex-shrink: 0;"> Diabetes (controlled)</label>
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_dm_comp" data-predictor="Complicated DA" style="margin-right: 5px; flex-shrink: 0;"> Diabetes (uncontrolled)</label>
            <!-- Renal -->
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_renal_mild" data-predictor="Mild/Moderate Renal Disease" style="margin-right: 5px; flex-shrink: 0;"> Renal disease (mild/moderate)</label>
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_renal_severe" data-predictor="Severe Renal Disease" style="margin-right: 5px; flex-shrink: 0;"> Renal disease (severe)</label>
            <!-- Malignancy -->
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_malign" data-predictor="Malignancy" style="margin-right: 5px; flex-shrink: 0;"> Malignancy (localized)</label>
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_met" data-predictor="Metastasis" style="margin-right: 5px; flex-shrink: 0;"> Malignancy (metastatic)</label>
            <!-- Other -->
            <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;"><input type="checkbox" id="cm_aids" data-predictor="AIDS" style="margin-right: 5px; flex-shrink: 0;"> AIDS</label>
        </div>
    </div>

    <div style="text-align: center; margin: 15px 0;">
        <button id="calculateButton" class="calculate-button" style="padding: 12px 30px; font-size: 1em;">Calculate risk</button>
    </div>

    <div class="card" style="padding: 15px; margin-bottom: 10px;">
        <h3 style="margin: 0 0 8px 0; font-size: 1.1em;">Results</h3>
        
        <div id="resultsGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="results-container" style="padding: 12px;">
                <div class="outcome-title" style="font-size: 1em; margin-bottom: 6px; font-weight: bold;">6-month risk</div>
                <div class="predicted-probability" id="probabilityValue6m" style="font-size: 2em; margin: 8px 0;">—</div>
                <div class="confidence-intervals" id="ciText6m" style="font-size: 0.9em;">—</div>
            </div>
            
            <div class="results-container" style="padding: 12px;">
                <div class="outcome-title" style="font-size: 1em; margin-bottom: 6px; font-weight: bold;">12-month risk</div>
                <div class="predicted-probability" id="probabilityValue12m" style="font-size: 2em; margin: 8px 0;">—</div>
                <div class="confidence-intervals" id="ciText12m" style="font-size: 0.9em;">—</div>
            </div>
        </div>

        <details style="margin-top: 10px;">
            <summary style="font-size: 0.9em; cursor: pointer;">Debug details (X, β, contributions)</summary>
            <div style="overflow-x: auto; margin-top: 8px;">
                <div style="margin-bottom: 15px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 0.95em; font-weight: bold;">6-month model</h4>
                    <pre id="debugSummary6m" style="white-space: pre-wrap; font-size: 0.85em; margin: 0 0 8px 0;">—</pre>
                    <table id="debugTable6m" class="results-table" style="width:100%; font-size: 0.85em; border-collapse: collapse; margin-bottom: 15px;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Predictor</th>
                                <th style="padding: 6px; text-align: right; border: 1px solid #ddd;">x</th>
                                <th style="padding: 6px; text-align: right; border: 1px solid #ddd;">β</th>
                                <th style="padding: 6px; text-align: right; border: 1px solid #ddd;">x·β</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div>
                    <h4 style="margin: 0 0 8px 0; font-size: 0.95em; font-weight: bold;">12-month model</h4>
                    <pre id="debugSummary12m" style="white-space: pre-wrap; font-size: 0.85em; margin: 0 0 8px 0;">—</pre>
                    <table id="debugTable12m" class="results-table" style="width:100%; font-size: 0.85em; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="padding: 6px; text-align: left; border: 1px solid #ddd;">Predictor</th>
                                <th style="padding: 6px; text-align: right; border: 1px solid #ddd;">x</th>
                                <th style="padding: 6px; text-align: right; border: 1px solid #ddd;">β</th>
                                <th style="padding: 6px; text-align: right; border: 1px solid #ddd;">x·β</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </details>
    </div>

    <div class="card">
        <h3>Learn more about our methodology</h3>
        <p>Understand the science behind our calculations.</p>
        <button onclick="location.href='methodology.html';">View methodology</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const calculateButton = document.getElementById('calculateButton');
            const errorBox = document.getElementById('error-message-container');

            function readNumberOrNull(id) {
                const el = document.getElementById(id);
                const raw = (el?.value ?? "").trim();
                if (!raw) return null;
                const num = Number(raw);
                return Number.isFinite(num) ? num : null;
            }

            function setError(msg) {
                if (!msg) {
                    errorBox.textContent = '';
                    errorBox.style.display = 'none';
                    return;
                }
                errorBox.textContent = msg;
                errorBox.style.display = 'block';
            }

            function validateRanges(values) {
                const { age, labs } = values;
                if (!Number.isFinite(age) || age < 18 || age > 90) return 'Age must be between 18 and 90.';
                const checks = [
                    ['Sodium', labs.sodium, 90, 200],
                    ['Creatinine', labs.creatinine, 0, 25],
                    ['Platelets (K/µL)', labs.platelet_k, 0, 2000],
                    ['Albumin', labs.albumin, 0, 10],
                    ['INR', labs.inr, 0, 20],
                    ['Bilirubin', labs.bilirubin, 0, 100],
                ];
                for (const [name, v, lo, hi] of checks) {
                    if (v == null) continue;
                    if (!Number.isFinite(v) || v < lo || v > hi) return `${name} is out of expected range (${lo}–${hi}).`;
                }
                return null;
            }

            function buildFormValues() {
                const age = Number((document.getElementById('ageInput')?.value ?? '').trim());
                const gender = document.querySelector('input[name="gender"]:checked')?.value ?? 'female';
                const female = gender === 'female';
                const etiology = document.getElementById('etiology')?.value ?? 'MASLD';
                const hcc = !!document.getElementById('hcc')?.checked;

                /** @type {Record<string, boolean>} */
                const comorbidities = {};
                document.querySelectorAll('input[type="checkbox"][data-predictor]').forEach((el) => {
                    const p = el.getAttribute('data-predictor');
                    if (!p) return;
                    comorbidities[p] = /** @type {HTMLInputElement} */ (el).checked;
                });

                return {
                    age,
                    female,
                    etiology,
                    hcc,
                    labs: {
                        sodium: readNumberOrNull('labSodium'),
                        creatinine: readNumberOrNull('labCreatinine'),
                        platelet_k: readNumberOrNull('labPlatelet'),
                        albumin: readNumberOrNull('labAlbumin'),
                        inr: readNumberOrNull('labINR'),
                        bilirubin: readNumberOrNull('labBilirubin'),
                    },
                    comorbidities,
                };
            }

            function renderDebug(result) {
                const summary6m = document.getElementById('debugSummary6m');
                const tbody6m = document.querySelector('#debugTable6m tbody');
                if (summary6m && tbody6m) {
                    const etiology = document.getElementById('etiology')?.value ?? 'MASLD';
                    const masldValue = (etiology === 'MASLD') ? 1 : 0;

                    summary6m.textContent =
                        `z (logit): ${result.z6m.toFixed(6)}\n` +
                        `p: ${(result.p6m * 100).toFixed(2)}%\n` +
                        (result.ci6m ? `se: ${result.ci6m.se.toFixed(6)}\n` : `se: (Σ not loaded)\n`) +
                        `predictors: ${result.model6m.predictors.length} (+ MASLD baseline)`;

                    tbody6m.innerHTML = '';
                    for (const row of result.contributions6m) {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid #eee';
                        const displayName = row.displayName || row.name;
                        tr.innerHTML =
                            `<td style="padding: 4px 6px;">${displayName}</td>` +
                            `<td style="padding: 4px 6px; text-align: right;">${Number(row.x).toFixed(6)}</td>` +
                            `<td style="padding: 4px 6px; text-align: right;">${Number(row.beta).toFixed(6)}</td>` +
                            `<td style="padding: 4px 6px; text-align: right;">${Number(row.contrib).toFixed(6)}</td>`;
                        tbody6m.appendChild(tr);
                    }
                    const masldRow6m = document.createElement('tr');
                    masldRow6m.style.fontStyle = 'italic';
                    masldRow6m.style.backgroundColor = '#f9f9f9';
                    masldRow6m.style.borderTop = '2px solid #ccc';
                    masldRow6m.innerHTML =
                        `<td style="padding: 4px 6px;">MASLD (baseline)</td>` +
                        `<td style="padding: 4px 6px; text-align: right;">${masldValue.toFixed(6)}</td>` +
                        `<td style="padding: 4px 6px; text-align: right;">0.000000</td>` +
                        `<td style="padding: 4px 6px; text-align: right;">0.000000</td>`;
                    tbody6m.appendChild(masldRow6m);
                }

                const summary12m = document.getElementById('debugSummary12m');
                const tbody12m = document.querySelector('#debugTable12m tbody');
                if (summary12m && tbody12m) {
                    const etiology = document.getElementById('etiology')?.value ?? 'MASLD';
                    const masldValue = (etiology === 'MASLD') ? 1 : 0;

                    summary12m.textContent =
                        `z (logit): ${result.z12m.toFixed(6)}\n` +
                        `p: ${(result.p12m * 100).toFixed(2)}%\n` +
                        (result.ci12m ? `se: ${result.ci12m.se.toFixed(6)}\n` : `se: (Σ not loaded)\n`) +
                        `predictors: ${result.model12m.predictors.length} (+ MASLD baseline)`;

                    tbody12m.innerHTML = '';
                    for (const row of result.contributions12m) {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid #eee';
                        const displayName = row.displayName || row.name;
                        tr.innerHTML =
                            `<td style="padding: 4px 6px;">${displayName}</td>` +
                            `<td style="padding: 4px 6px; text-align: right;">${Number(row.x).toFixed(6)}</td>` +
                            `<td style="padding: 4px 6px; text-align: right;">${Number(row.beta).toFixed(6)}</td>` +
                            `<td style="padding: 4px 6px; text-align: right;">${Number(row.contrib).toFixed(6)}</td>`;
                        tbody12m.appendChild(tr);
                    }
                    const masldRow12m = document.createElement('tr');
                    masldRow12m.style.fontStyle = 'italic';
                    masldRow12m.style.backgroundColor = '#f9f9f9';
                    masldRow12m.style.borderTop = '2px solid #ccc';
                    masldRow12m.innerHTML =
                        `<td style="padding: 4px 6px;">MASLD (baseline)</td>` +
                        `<td style="padding: 4px 6px; text-align: right;">${masldValue.toFixed(6)}</td>` +
                        `<td style="padding: 4px 6px; text-align: right;">0.000000</td>` +
                        `<td style="padding: 4px 6px; text-align: right;">0.000000</td>`;
                    tbody12m.appendChild(masldRow12m);
                }
            }

            async function onCalculate() {
                setError(null);
                calculateButton.classList.add('processing');
                calculateButton.textContent = 'Calculating...';

                try {
                    if (!window.PROTOTYPE2_SIGMA_6MO || !window.PROTOTYPE2_SIGMA_12MO) {
                        if (window.LoadSigma) {
                            await Promise.all([
                                window.LoadSigma.loadSigma6m(),
                                window.LoadSigma.loadSigma12m()
                            ]);
                        }
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    const formValues = buildFormValues();
                    const rangeErr = validateRanges(formValues);
                    if (rangeErr) {
                        setError(rangeErr);
                        return;
                    }

                    const sigmaInput6m = window.PROTOTYPE2_SIGMA_6MO;
                    const sigmaInput12m = window.PROTOTYPE2_SIGMA_12MO;
                    const result = await window.Prototype2Model.evaluate(formValues, { 
                        sigma6m: sigmaInput6m,
                        sigma12m: sigmaInput12m
                    });

                    const probEl6m = document.getElementById('probabilityValue6m');
                    const ciEl6m = document.getElementById('ciText6m');
                    if (probEl6m) probEl6m.textContent = `${(result.p6m * 100).toFixed(2)}%`;
                    if (ciEl6m) {
                        if (result.ci6m) {
                            ciEl6m.textContent =
                                `CI (approx): ${(result.ci6m.lower * 100).toFixed(2)}% – ${(result.ci6m.upper * 100).toFixed(2)}%`;
                        } else {
                            ciEl6m.textContent = 'Note: Sigma for CI';
                        }
                    }

                    const probEl12m = document.getElementById('probabilityValue12m');
                    const ciEl12m = document.getElementById('ciText12m');
                    if (probEl12m) probEl12m.textContent = `${(result.p12m * 100).toFixed(2)}%`;
                    if (ciEl12m) {
                        if (result.ci12m) {
                            ciEl12m.textContent =
                                `CI (approx): ${(result.ci12m.lower * 100).toFixed(2)}% – ${(result.ci12m.upper * 100).toFixed(2)}%`;
                        } else {
                            ciEl12m.textContent = 'Note: Sigma for CI';
                        }
                    }

                    renderDebug(result);
                } catch (e) {
                    setError(`Calculation failed: ${e?.message ?? e}`);
                } finally {
                    calculateButton.classList.remove('processing');
                    calculateButton.textContent = 'Calculate risk';
                }
            }

            calculateButton.addEventListener('click', onCalculate);
        });
    </script>
</body>
</html>
